<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JynxAI - Universal Chat</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;600&family=Inter:wght@300;400;600&family=Libre+Baskerville:wght@400;700&family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;600&family=Quicksand:wght@400;600&family=Roboto+Mono:wght@400&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gemini: {
                            50: '#f0f4f9',
                            100: '#e1e7ee',
                            800: '#1e1f20',
                            900: '#131314',
                            accent: '#4285f4'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark ::-webkit-scrollbar-thumb { background-color: #475569; }

        /* Liquid Glass (iOS 26 Future Concept) */
        .liquid-glass {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        .dark .liquid-glass {
            background: rgba(19, 19, 20, 0.65);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* 2. FONT FAMILY CLASSES (Updated) */
        .font-iphone { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .font-samsung { font-family: "Roboto", sans-serif; } /* Samsung uses Roboto mostly, or OneUI which is proprietary */
        .font-stylish { font-family: "Playfair Display", serif; }
        .font-minimal { font-family: "Quicksand", sans-serif; }
        
        /* New Fonts */
        .font-roboto { font-family: 'Roboto', sans-serif; }
        .font-helvetica { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
        .font-inter { font-family: 'Inter', sans-serif; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        .font-garamond { font-family: 'EB Garamond', serif; }
        .font-baskerville { font-family: 'Libre Baskerville', serif; }

        /* Loader */
        #loading {
            position: fixed; inset: 0; background: #fff; z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.5s ease;
        }
        .dark #loading { background: #131314; color: white; }
        
        /* Markdown Styles */
        .prose pre { background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; }
        .dark .prose pre { background-color: #1e1e1e; }
        .prose code { font-family: 'Roboto Mono', monospace; font-size: 0.9em; color: #d946ef; }
        .dark .prose code { color: #f0abfc; }
        .prose p { margin-bottom: 0.5rem; }

        /* Animation Classes */
        .anim-enabled .msg-anim { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .no-anim .msg-anim { animation: none; opacity: 1; transform: translateY(0); }
        
        /* Cursor Blink */
        .typing-cursor::after { content: 'â–‹'; animation: blink 1s step-start infinite; color: #4285f4; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-gemini-50 text-gray-800 dark:bg-gemini-900 dark:text-gray-100 h-[100dvh] overflow-hidden transition-colors duration-300 font-iphone text-base">

    <div id="loading">
        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold tracking-widest">JynxAI</h2>
    </div>

    <div id="app" class="flex h-full w-full opacity-0 transition-opacity duration-500">
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 flex flex-col border-r border-gray-200 dark:border-gray-800 bg-white/90 dark:bg-gemini-900/95 backdrop-blur-md">
            
            <div class="p-4 border-b border-gray-200 dark:border-gray-800">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-purple-600">JynxAI</h1>
                        <p class="text-[10px] text-gray-400 font-mono tracking-wide">made by ShuvojitTG</p>
                    </div>
                    <button id="close-sidebar-btn" class="md:hidden p-2 text-gray-500 hover:text-blue-500">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <button id="new-chat-btn" class="mt-4 w-full flex items-center justify-center gap-2 px-4 py-3 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-xl transition-all font-medium text-sm">
                    <i class="fa-solid fa-plus"></i> New Chat
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-2 space-y-1" id="chat-list">
                </div>

            <div class="p-4 border-t border-gray-200 dark:border-gray-800">
                <button id="open-settings-btn" class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors">
                    <i class="fa-solid fa-gear"></i> Settings
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col w-full relative h-full">
            
            <header class="md:hidden flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gemini-900/80 backdrop-blur-sm z-30">
                <button id="mobile-menu-btn" class="p-2 -ml-2 text-gray-600 dark:text-gray-300">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <span class="font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-purple-600">JynxAI</span>
                <div class="w-8"></div> </header>

            <div id="messages-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth pb-32">
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full opacity-60 text-center">
                    <i class="fa-solid fa-wand-magic-sparkles text-6xl mb-6 text-blue-500 animate-pulse-slow"></i>
                    <h2 class="text-3xl font-bold mb-2">How can I help you today?</h2>
                    <p class="text-sm text-gray-500">Configured with OpenRouter API</p>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 p-4 md:p-6 bg-gradient-to-t from-white via-white to-transparent dark:from-gemini-900 dark:via-gemini-900 z-20">
                <div id="input-wrapper" class="max-w-4xl mx-auto relative rounded-3xl shadow-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gemini-800 overflow-hidden transition-all duration-300">
                    <textarea 
                        id="user-input" 
                        rows="1" 
                        placeholder="Message JynxAI..." 
                        class="w-full pl-6 pr-14 py-4 bg-transparent outline-none resize-none max-h-48 text-base md:text-lg"
                    ></textarea>
                    
                    <button id="send-btn" class="absolute right-3 bottom-3 p-2 bg-blue-500 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all transform active:scale-95">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>
                <div class="text-center mt-2">
                    <p class="text-[10px] text-gray-400">JynxAI may display inaccurate info.</p>
                </div>
            </div>
        </main>

        <div id="settings-modal" class="fixed inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="settings-backdrop"></div>
            
            <div class="absolute inset-x-0 bottom-0 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 w-full md:w-[600px] max-h-[90dvh] bg-white dark:bg-gemini-900 md:rounded-2xl rounded-t-2xl shadow-2xl flex flex-col transition-all overflow-hidden border border-gray-200 dark:border-gray-800">
                
                <div class="p-4 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50">
                    <h2 class="text-xl font-bold">Settings</h2>
                    <button id="close-settings-btn" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition-colors">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-6 space-y-8">
                    
                    <section>
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4">API Configuration</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">OpenRouter API Key</label>
                                <input type="password" id="setting-api-key" class="w-full p-3 rounded-lg border dark:border-gray-700 bg-gray-50 dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="sk-or-...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Model Name</label>
                                <input type="text" id="setting-model" class="w-full p-3 rounded-lg border dark:border-gray-700 bg-gray-50 dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="deepseek/deepseek-r1:free">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">System Prompt</label>
                                <textarea id="setting-system-prompt" rows="3" class="w-full p-3 rounded-lg border dark:border-gray-700 bg-gray-50 dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="You are a helpful AI..."></textarea>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4">Appearance</h3>
                        
                        <div class="flex items-center justify-between mb-4">
                            <span>Dark Mode</span>
                            <button id="toggle-dark-mode" class="w-12 h-6 bg-gray-300 rounded-full relative transition-colors duration-300 dark:bg-blue-600">
                                <span class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300 dark:translate-x-6"></span>
                            </button>
                        </div>

                        <div class="flex items-center justify-between mb-4">
                            <span>iOS 26 Liquid Glass</span>
                            <button id="toggle-glass" class="w-12 h-6 bg-gray-300 rounded-full relative transition-colors duration-300">
                                <span class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300"></span>
                            </button>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Font Style</label>
                            <select id="setting-font-style" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-800 border-none outline-none">
                                <option value="font-iphone">iPhone (System)</option>
                                <option value="font-samsung">Samsung (Roboto)</option>
                                <option value="font-helvetica">Helvetica Neue</option>
                                <option value="font-inter">Inter</option>
                                <option value="font-poppins">Poppins</option>
                                <option value="font-stylish">Playfair Display (Stylish)</option>
                                <option value="font-garamond">Garamond</option>
                                <option value="font-baskerville">Baskerville</option>
                                <option value="font-minimal">Quicksand (Minimal)</option>
                            </select>
                        </div>

                         <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Text Size Scale</label>
                            <input type="range" id="setting-text-size" min="12" max="24" value="16" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                        </div>
                    </section>

                    <section>
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4">Animations</h3>
                        
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex flex-col">
                                <span>Smooth Animations (Telegram Style)</span>
                                <span class="text-xs text-gray-500">Enable granular controls below</span>
                            </div>
                            <button id="toggle-anim-master" class="w-12 h-6 bg-gray-300 rounded-full relative transition-colors duration-300">
                                <span class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300"></span>
                            </button>
                        </div>

                        <div id="anim-sub-controls" class="pl-4 border-l-2 border-gray-200 dark:border-gray-700 space-y-3 opacity-50 pointer-events-none transition-opacity">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="anim-text" class="rounded text-blue-500">
                                <span class="text-sm">Typing Animation (Letter-by-letter)</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="anim-slide" class="rounded text-blue-500">
                                <span class="text-sm">Message Slide-in</span>
                            </label>
                        </div>
                    </section>
                </div>
                
                <div class="p-4 border-t border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50 text-right">
                    <button id="save-settings-btn" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors font-medium shadow-md">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS & STATE ---
        const DEFAULT_MODEL = "deepseek/deepseek-r1:free";
        const STORAGE_KEY = "jynx_ai_v1";
        
        // Initial State
        let state = {
            apiKey: "",
            model: DEFAULT_MODEL,
            systemPrompt: "You are JynxAI, a helpful, witty, and concise AI assistant.",
            chats: [], // { id, title, messages: [] }
            currentChatId: null,
            settings: {
                darkMode: false,
                glassEffect: false,
                animMaster: false,
                animText: true,
                animSlide: true,
                fontStyle: 'font-iphone',
                textSize: 16
            }
        };

        // --- DOM ELEMENTS ---
        const els = {
            app: document.getElementById('app'),
            loader: document.getElementById('loading'),
            sidebar: document.getElementById('sidebar'),
            chatList: document.getElementById('chat-list'),
            msgContainer: document.getElementById('messages-container'),
            input: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            inputWrapper: document.getElementById('input-wrapper'),
            welcome: document.getElementById('welcome-screen'),
            // Modals & Toggles
            settingsModal: document.getElementById('settings-modal'),
            settingsBackdrop: document.getElementById('settings-backdrop'),
            // Inputs in Settings
            setApiKey: document.getElementById('setting-api-key'),
            setModel: document.getElementById('setting-model'),
            setSysPrompt: document.getElementById('setting-system-prompt'),
            setDark: document.getElementById('toggle-dark-mode'),
            setGlass: document.getElementById('toggle-glass'),
            setFont: document.getElementById('setting-font-style'),
            setSize: document.getElementById('setting-text-size'),
            setAnimMaster: document.getElementById('toggle-anim-master'),
            setAnimText: document.getElementById('anim-text'),
            setAnimSlide: document.getElementById('anim-slide'),
            animSub: document.getElementById('anim-sub-controls'),
        };

        // --- CORE FUNCTIONS ---

        function init() {
            loadState();
            applySettings();
            renderSidebar();
            
            if (state.chats.length > 0) {
                if (state.currentChatId) {
                    loadChat(state.currentChatId);
                } else {
                    createNewChat();
                }
            } else {
                createNewChat();
            }

            // Remove Loader
            setTimeout(() => {
                els.loader.style.opacity = '0';
                els.app.style.opacity = '1';
                setTimeout(() => els.loader.remove(), 500);
            }, 500);
        }

        // Persistence
        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed, settings: { ...state.settings, ...parsed.settings } };
            }
        }

        // --- UI RENDERING ---

        function applySettings() {
            const s = state.settings;
            
            // Dark Mode
            document.documentElement.classList.toggle('dark', s.darkMode);
            updateToggleVisual(els.setDark, s.darkMode);

            // Font (UPDATED LOGIC)
            // Remove any class starting with 'font-' to prevent conflicts
            const classes = document.body.className.split(" ").filter(c => !c.startsWith("font-"));
            document.body.className = classes.join(" ");
            document.body.classList.add(s.fontStyle);
            els.setFont.value = s.fontStyle;

            // Text Size
            document.documentElement.style.fontSize = s.textSize + 'px';
            els.setSize.value = s.textSize;

            // Liquid Glass (iOS 26)
            const glassTarget = els.inputWrapper;
            const glassSidebar = els.sidebar;
            if (s.glassEffect) {
                glassTarget.classList.add('liquid-glass');
                glassTarget.classList.remove('bg-white', 'dark:bg-gemini-800');
                glassSidebar.classList.add('liquid-glass');
                glassSidebar.classList.remove('bg-white/90', 'dark:bg-gemini-900/95');
            } else {
                glassTarget.classList.remove('liquid-glass');
                glassTarget.classList.add('bg-white', 'dark:bg-gemini-800');
                glassSidebar.classList.remove('liquid-glass');
                glassSidebar.classList.add('bg-white/90', 'dark:bg-gemini-900/95');
            }
            updateToggleVisual(els.setGlass, s.glassEffect);

            // Animations
            document.body.classList.toggle('anim-enabled', s.animMaster);
            document.body.classList.toggle('no-anim', !s.animMaster);
            updateToggleVisual(els.setAnimMaster, s.animMaster);
            
            els.animSub.style.opacity = s.animMaster ? '1' : '0.5';
            els.animSub.style.pointerEvents = s.animMaster ? 'auto' : 'none';
            els.setAnimText.checked = s.animText;
            els.setAnimSlide.checked = s.animSlide;

            // Fill Inputs
            els.setApiKey.value = state.apiKey;
            els.setModel.value = state.model;
            els.setSysPrompt.value = state.systemPrompt;
        }

        function updateToggleVisual(btn, isActive) {
            const knob = btn.querySelector('span');
            if (isActive) {
                btn.classList.add('bg-blue-600');
                btn.classList.remove('bg-gray-300');
                knob.classList.add('translate-x-6');
            } else {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-300');
                knob.classList.remove('translate-x-6');
            }
        }

        function renderSidebar() {
            els.chatList.innerHTML = '';
            state.chats.forEach(chat => {
                const div = document.createElement('div');
                const isAuth = chat.id === state.currentChatId;
                div.className = `group flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors ${isAuth ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' : 'hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300'}`;
                
                div.innerHTML = `
                    <i class="fa-regular fa-message text-sm"></i>
                    <div class="flex-1 truncate text-sm font-medium" id="title-${chat.id}">${chat.title}</div>
                    <div class="hidden group-hover:flex gap-2">
                        <button class="text-xs hover:text-blue-500 p-1" onclick="renameChat(event, '${chat.id}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="text-xs hover:text-red-500 p-1" onclick="deleteChat(event, '${chat.id}')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                div.onclick = (e) => {
                    if(e.target.closest('button')) return;
                    loadChat(chat.id);
                    if(window.innerWidth < 768) toggleSidebar(false);
                };
                els.chatList.prepend(div);
            });
        }

        function renderMessages() {
            els.msgContainer.innerHTML = '';
            const chat = state.chats.find(c => c.id === state.currentChatId);
            
            if (!chat || chat.messages.length === 0) {
                els.msgContainer.appendChild(els.welcome);
                return;
            }

            chat.messages.forEach(msg => {
                appendMessageToUI(msg.role, msg.content, false);
            });
            scrollToBottom();
        }

        function appendMessageToUI(role, content, animate = true) {
            if (els.welcome.parentNode) els.welcome.remove();

            const isUser = role === 'user';
            const wrapper = document.createElement('div');
            wrapper.className = `w-full flex ${isUser ? 'justify-end' : 'justify-start'} msg-anim opacity-0 transform translate-y-4`;
            
            if (state.settings.animMaster && state.settings.animSlide && animate) {
               // Animation handled by CSS class
            } else {
                wrapper.style.animation = 'none';
                wrapper.style.opacity = '1';
                wrapper.style.transform = 'translateY(0)';
            }

            const bubble = document.createElement('div');
            bubble.className = `max-w-[85%] md:max-w-[70%] rounded-2xl px-4 py-3 text-sm md:text-base shadow-sm ${
                isUser 
                ? 'bg-blue-600 text-white rounded-br-sm' 
                : 'bg-white dark:bg-gemini-800 border border-gray-100 dark:border-gray-700 text-gray-800 dark:text-gray-100 rounded-bl-sm'
            }`;

            if (isUser) {
                bubble.innerText = content;
            } else {
                bubble.classList.add('prose', 'dark:prose-invert', 'max-w-none');
                bubble.innerHTML = marked.parse(content);
            }

            wrapper.appendChild(bubble);
            els.msgContainer.appendChild(wrapper);
            return { wrapper, bubble };
        }

        function scrollToBottom() {
            els.msgContainer.scrollTop = els.msgContainer.scrollHeight;
        }

        // --- CHAT LOGIC ---

        function createNewChat() {
            const newChat = {
                id: Date.now().toString(),
                title: 'New Chat',
                messages: []
            };
            state.chats.push(newChat);
            state.currentChatId = newChat.id;
            saveState();
            renderSidebar();
            renderMessages();
        }

        function loadChat(id) {
            state.currentChatId = id;
            saveState();
            renderSidebar();
            renderMessages();
        }

        function deleteChat(e, id) {
            e.stopPropagation();
            if(confirm("Delete this chat?")) {
                state.chats = state.chats.filter(c => c.id !== id);
                if (state.currentChatId === id) {
                    state.currentChatId = state.chats.length > 0 ? state.chats[state.chats.length - 1].id : null;
                }
                if (!state.currentChatId && state.chats.length === 0) createNewChat();
                else {
                    saveState();
                    renderSidebar();
                    renderMessages();
                }
            }
        }

        function renameChat(e, id) {
            e.stopPropagation();
            const newName = prompt("Enter new chat name:");
            if (newName) {
                const chat = state.chats.find(c => c.id === id);
                if (chat) {
                    chat.title = newName;
                    saveState();
                    renderSidebar();
                }
            }
        }

        // --- API & STREAMING ---

        async function handleSend() {
            const text = els.input.value.trim();
            if (!text) return;
            if (!state.apiKey) {
                alert("Please set your OpenRouter API Key in Settings first.");
                document.getElementById('open-settings-btn').click();
                return;
            }

            els.input.value = '';
            els.input.style.height = 'auto';
            const chat = state.chats.find(c => c.id === state.currentChatId);
            
            chat.messages.push({ role: 'user', content: text });
            appendMessageToUI('user', text, true);
            scrollToBottom();
            
            if (chat.messages.length === 1) {
                chat.title = text.substring(0, 30) + (text.length > 30 ? '...' : '');
                renderSidebar();
            }

            const { bubble } = appendMessageToUI('assistant', '', true);
            bubble.innerHTML = '<span class="typing-cursor"></span>';
            
            const messagesPayload = [
                { role: 'system', content: state.systemPrompt },
                ...chat.messages
            ];

            let aiContent = "";

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${state.apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href,
                        "X-Title": "JynxAI"
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: messagesPayload,
                        stream: true
                    })
                });

                if (!response.ok) throw new Error("API Error");

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.slice(6);
                            if (jsonStr === '[DONE]') break;
                            try {
                                const json = JSON.parse(jsonStr);
                                const token = json.choices[0]?.delta?.content || "";
                                
                                if (token) {
                                    aiContent += token;
                                    
                                    if (state.settings.animMaster && state.settings.animText) {
                                        bubble.innerHTML = marked.parse(aiContent) + '<span class="typing-cursor"></span>';
                                    } else {
                                        bubble.innerHTML = marked.parse(aiContent);
                                    }
                                    scrollToBottom();
                                }
                            } catch (e) { console.error("Parse error", e); }
                        }
                    }
                }

                bubble.innerHTML = marked.parse(aiContent);
                chat.messages.push({ role: 'assistant', content: aiContent });
                saveState();

            } catch (error) {
                bubble.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
                chat.messages.push({ role: 'assistant', content: "Error: " + error.message });
                saveState();
            }
        }

        // --- EVENT LISTENERS ---

        els.input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        els.input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

        els.sendBtn.addEventListener('click', handleSend);

        const toggleSidebar = (show) => {
            if (show) els.sidebar.classList.remove('-translate-x-full');
            else els.sidebar.classList.add('-translate-x-full');
        };

        document.getElementById('mobile-menu-btn').addEventListener('click', () => toggleSidebar(true));
        document.getElementById('close-sidebar-btn').addEventListener('click', () => toggleSidebar(false));
        document.getElementById('new-chat-btn').addEventListener('click', () => {
            createNewChat();
            if(window.innerWidth < 768) toggleSidebar(false);
        });

        document.getElementById('open-settings-btn').addEventListener('click', () => {
            els.settingsModal.classList.remove('hidden');
            applySettings();
        });

        const closeSettings = () => {
            els.settingsModal.classList.add('hidden');
        };

        document.getElementById('close-settings-btn').addEventListener('click', closeSettings);
        els.settingsBackdrop.addEventListener('click', closeSettings);

        function setupToggle(btn, settingKey, callback) {
            btn.addEventListener('click', () => {
                state.settings[settingKey] = !state.settings[settingKey];
                updateToggleVisual(btn, state.settings[settingKey]);
                if (callback) callback();
            });
        }

        setupToggle(els.setDark, 'darkMode', applySettings);
        setupToggle(els.setGlass, 'glassEffect', applySettings);
        setupToggle(els.setAnimMaster, 'animMaster', applySettings);

        els.setAnimText.addEventListener('change', (e) => state.settings.animText = e.target.checked);
        els.setAnimSlide.addEventListener('change', (e) => state.settings.animSlide = e.target.checked);
        
        els.setFont.addEventListener('change', (e) => {
            state.settings.fontStyle = e.target.value;
            applySettings();
        });

        els.setSize.addEventListener('input', (e) => {
            state.settings.textSize = e.target.value;
            applySettings();
        });

        document.getElementById('save-settings-btn').addEventListener('click', () => {
            state.apiKey = els.setApiKey.value.trim();
            state.model = els.setModel.value.trim() || DEFAULT_MODEL;
            state.systemPrompt = els.setSysPrompt.value.trim();
            saveState();
            closeSettings();
        });

        window.addEventListener('load', init);

    </script>
</body>
</html>
